<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Account | EZ Sports Netting</title>
  <link rel="icon" href="assets/img/favicon-32.png" type="image/png" />
  <link rel="stylesheet" href="assets/css/styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="container header-bar">
      <button class="menu-toggle" aria-label="Toggle menu" aria-expanded="false" aria-controls="primary-nav">â˜°</button>
      <a class="brand" href="index.html">
  <img src="assets/EZSportslogo.png" alt="EZ Sports Netting logo" height="40"/>
        <span>EZ Sports Netting</span>
      </a>
      <form class="search" role="search" aria-label="Search store">
  <input type="search" name="q" placeholder="Searchâ€¦" aria-label="Search"/>
        <button type="submit" class="btn btn-primary">Search</button>
      </form>
      <nav id="primary-nav" class="quick-links nav-centered" aria-label="Primary">
        <a href="about.html">About</a>
        <a href="netting-calculator.html">Netting Calculator</a>
        <button class="cart-btn" aria-haspopup="dialog" aria-controls="mini-cart" onclick="Store.toggleCart()">
          <span class="icon">ðŸ›’</span>
          <span class="cart-count" id="cart-count">0</span>
        </button>
      </nav>
    </div>
  </header>

  <main id="main" class="container">
    <nav class="breadcrumbs container wrap" aria-label="Breadcrumb">
      <ol class="crumbs">
        <li><a href="index.html">Home</a></li>
        <li><span aria-current="page">Account</span></li>
      </ol>
    </nav>

    <section class="auth-container wide">
      <h2 class="mt-0">My Account</h2>
      <p class="muted">Update your profile information.</p>

      <form id="account-form" class="auth-form">
        <div class="grid-2">
          <input type="text" id="acc-firstName" name="firstName" placeholder="First name" />
          <input type="text" id="acc-lastName" name="lastName" placeholder="Last name" />
        </div>
        <input type="email" id="acc-email" name="email" placeholder="Email" disabled />
        <input type="text" id="acc-name" name="name" placeholder="Display name" />
        <button class="btn btn-primary" type="submit">Save Changes</button>
        <div id="account-msg" class="text-center" aria-live="polite"></div>
      </form>

  <details class="info-block mt-1r">
        <summary>Change password</summary>
        <div class="info-content">
          <form id="password-form" class="auth-form">
            <input type="password" id="oldPassword" placeholder="Current password" required />
            <input type="password" id="newPassword" placeholder="New password (min 6 chars)" required />
            <button class="btn btn-primary" type="submit">Update Password</button>
            <div id="password-msg" class="text-center" aria-live="polite"></div>
          </form>
        </div>
      </details>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container footer-grid">
      <div class="footer-brand-block">
        <a class="brand brand--light" href="index.html">
          <img src="assets/EZSportslogo.png" alt="EZ Sports Netting logo" height="36"/>
          <span>EZ Sports Netting</span>
        </a>
        <p class="muted">Better baseball through better gear.</p>
        <div class="socials" aria-label="social links">
          <a href="https://www.facebook.com/Ezsportsnetting/" aria-label="Facebook" target="_blank" rel="noopener">
            <img src="assets/img/facebook.png" alt="Facebook" />
          </a>
          <a href="#" aria-label="Instagram"><img src="assets/img/instagram.png" alt="Instagram" /></a>
          <a href="#" aria-label="X"><img src="assets/img/xwhite.png" alt="X" /></a>
        </div>
      </div>
      <nav aria-label="Footer">
        <h4>Shop</h4>
        <ul>
          <li><a href="index.html#catalog" onclick="Store.filter('bats')">Bats</a></li>
          <li><a href="index.html#catalog" onclick="Store.filter('gloves')">Gloves</a></li>
          <li><a href="index.html#catalog" onclick="Store.filter('netting')">Netting</a></li>
          <li><a href="index.html#catalog" onclick="Store.filter('helmets')">Helmets</a></li>
        </ul>
      </nav>
      <nav>
        <h4>Company</h4>
        <ul>
          <li><a href="about.html">About</a></li>
          <li><a href="careers.html">Careers</a></li>
          <li><a href="contactus.html">Contact Us</a></li>
        </ul>
      </nav>
      <form class="subscribe" onsubmit="event.preventDefault(); alert('Thanks for subscribing!')">
        <h4>Get deals in your inbox</h4>
        <div class="row">
          <input type="email" placeholder="you@email.com" required />
          <button class="btn btn-primary" type="submit">Subscribe</button>
        </div>
      </form>
    </div>
    <div class="subfooter container">
      <p>Â© <span id="year"></span> EZ Sports Netting. All rights reserved.</p>
    </div>
  </footer>

  <dialog id="mini-cart" class="mini-cart" aria-labelledby="cart-title">
    <form method="dialog" class="mini-cart__backdrop" onclick="this.closest('dialog').close()"></form>
    <section class="mini-cart__panel" role="document">
      <header>
        <h3 id="cart-title">Your cart</h3>
        <button class="icon-btn" onclick="document.getElementById('mini-cart').close()" aria-label="Close">âœ•</button>
      </header>
      <div id="cart-items" class="mini-cart__items"></div>
      <footer class="mini-cart__footer">
        <div class="totals">
          <span>Subtotal</span>
          <strong id="cart-subtotal">$0.00</strong>
        </div>
        <div class="stack-05">
          <button type="button" class="btn btn-primary btn-block" onclick="Store.checkout()">Secure Checkout</button>
          <a class="btn btn-ghost btn-block" href="index.html">Continue Shopping</a>
        </div>
      </footer>
    </section>
  </dialog>

  <script type="module" src="assets/js/analytics.js"></script>
  <script type="module" src="assets/js/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Load current user and enforce auth for this page
      try {
        const user = JSON.parse(localStorage.getItem('currentUser')||'null');
        if (!user) {
          window.location.href = 'login.html?redirect=account.html';
          return;
        }
        document.getElementById('acc-email').value = user.email || '';
        document.getElementById('acc-name').value = user.name || '';
        document.getElementById('acc-firstName').value = user.firstName || '';
        document.getElementById('acc-lastName').value = user.lastName || '';
      } catch {}

      // Save profile
      const form = document.getElementById('account-form');
      const msg = document.getElementById('account-msg');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          const user = JSON.parse(localStorage.getItem('currentUser')||'null');
          if (!user) throw new Error('Not signed in');
          const body = {
            firstName: document.getElementById('acc-firstName').value.trim(),
            lastName: document.getElementById('acc-lastName').value.trim(),
            name: document.getElementById('acc-name').value.trim()
          };
          const base = window.__API_BASE || '';
          const res = await fetch(`${base}/api/users/profile/${user.id}`, {
            method:'PUT', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message||'Failed to update');
          // Persist updated user locally
          const updated = data.user || user;
          localStorage.setItem('currentUser', JSON.stringify(updated));
          msg.textContent = 'Profile updated';
          msg.classList.remove('text-error');
        } catch (err) {
          msg.textContent = err.message || 'Error saving profile';
          msg.classList.add('text-error');
        }
      });

      // Change password
      const pform = document.getElementById('password-form');
      const pmsg = document.getElementById('password-msg');
      pform.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          const user = JSON.parse(localStorage.getItem('currentUser')||'null');
          if (!user) throw new Error('Not signed in');
          const body = {
            oldPassword: document.getElementById('oldPassword').value,
            newPassword: document.getElementById('newPassword').value
          };
          if (String(body.newPassword||'').length < 6) throw new Error('New password too short');
          const base = window.__API_BASE || '';
          const res = await fetch(`${base}/api/users/change-password/${user.id}`, {
            method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message||'Failed to change password');
          pmsg.textContent = 'Password updated';
          pmsg.classList.remove('text-error');
          pform.reset();
        } catch (err) {
          pmsg.textContent = err.message || 'Error updating password';
          pmsg.classList.add('text-error');
        }
      });
    });
  </script>
</body>
</html>
