

 



# XP and Level Tests
class XPAndLevelTests(BackendTestBase):
	def test_xp_increases(self):
		p = Player(name="P")
		p.add_xp(10)
		self.assertEqual(p.current_xp, 10)
		self.assertEqual(p.level, 1)

	def test_level_increases_and_threshold_scales(self):
		p = Player(name="P")
		start_threshold = p.xp_to_next
		p.add_xp(start_threshold)
		self.assertEqual(p.level, 2)
		self.assertEqual(p.xp_to_next, start_threshold + 50)
		self.assertEqual(p.current_xp, 0)

	def test_multiple_level_ups(self):
		p = Player(name="P")
		p.add_xp(1000)
		self.assertGreaterEqual(p.level, 2)
		self.assertGreater(p.xp_to_next, 100)
		self.assertGreaterEqual(p.current_xp, 0)


# Persistence Tests
class PersistenceTests(BackendTestBase):
	def test_save_file_creation_and_update(self):
		player, gm = self._new_profile()
		storage = Storage("studyquest_save.txt")

		gm.add_task("T", "D", Difficulty.MEDIUM, date(2026, 2, 20))
		storage.save(player, gm)
		self.assertTrue(os.path.exists(storage.path))

		size1 = os.path.getsize(storage.path)
		gm.add_habit("H", "", Difficulty.EASY, Frequency.WEEKLY)
		storage.save(player, gm)
		size2 = os.path.getsize(storage.path)
		self.assertGreater(size2, size1)

	def test_load_restores_all_data(self):
		player, gm = self._new_profile()
		player.level = 3
		player.current_xp = 15
		player.xp_to_next = 200

		gm.add_task("T", "D", Difficulty.HARD, date(2026, 2, 20))
		gm.add_habit("H", "", Difficulty.EASY, Frequency.DAILY)
		gm.complete_by_id(2, date(2026, 2, 10))

		storage = Storage("studyquest_save.txt")
		storage.save(player, gm)

		p2, gm2 = storage.load()
		self.assertEqual(p2.name, player.name)
		self.assertEqual(p2.level, 3)
		self.assertEqual(p2.current_xp, 15)
		self.assertEqual(p2.xp_to_next, 200)
		self.assertEqual(len(gm2.goals), 2)

		t = next(g for g in gm2.goals if isinstance(g, Task))
		h = next(g for g in gm2.goals if isinstance(g, Habit))
		self.assertEqual(t.title, "T")
		self.assertEqual(t.due_date, date(2026, 2, 20))
		self.assertEqual(h.title, "H")
		self.assertEqual(h.last_completed, date(2026, 2, 10))
		self.assertEqual(h.current_streak, 1)

	def test_missing_file_behavior(self):
		storage = Storage("missing.txt")
		self.assertFalse(os.path.exists(storage.path))
		p, gm = storage.load()
		self.assertEqual(p.name, "Student")
		self.assertEqual(len(gm.goals), 0)

	def test_corrupted_file_behavior(self):
		storage = Storage("corrupt.txt")
		with open(storage.path, "w", encoding="utf-8") as f:
			f.write("NOTPLAYER|x\n")
		with self.assertRaises(ValueError):
			storage.load()

	def test_windows_path_handling_absolute_and_relative(self):
		player, gm = self._new_profile()
		gm.add_task("T", "", Difficulty.EASY, None)

		subdir = os.path.join(self._tmp.name, "nested")
		os.makedirs(subdir, exist_ok=True)
		abs_path = os.path.join(subdir, "studyquest_save.txt")
		storage_abs = Storage(abs_path)
		storage_abs.save(player, gm)
		self.assertTrue(os.path.exists(abs_path))

		storage_rel = Storage(os.path.join("nested", "studyquest_save.txt"))
		os.makedirs("nested", exist_ok=True)
		storage_rel.save(player, gm)
		self.assertTrue(os.path.exists(storage_rel.path))


# Cross-Platform Logic Tests
class CrossPlatformLogicTests(BackendTestBase):
	def test_save_file_format_consistency(self):
		player, gm = self._new_profile()
		gm.add_task("T", "D", Difficulty.EASY, date(2026, 2, 20))
		gm.add_habit("H", "", Difficulty.EASY, Frequency.DAILY)
		storage = Storage("studyquest_save.txt")
		storage.save(player, gm)

		raw = open(storage.path, "rb").read()
		self.assertIn(b"PLAYER|", raw)
		self.assertIn(b"GOAL|", raw)
		self.assertIn(b"\n", raw)

		lines = raw.decode("utf-8").splitlines()
		self.assertTrue(lines[0].startswith("PLAYER|"))
		self.assertTrue(any(ln.startswith("GOAL|TASK|") for ln in lines))
		self.assertTrue(any(ln.startswith("GOAL|HABIT|") for ln in lines))

	def test_status_texts_are_stable_strings(self):
		_, gm = self._new_profile()
		gm.add_task("T", "", Difficulty.EASY, None)
		gm.add_habit("H", "", Difficulty.EASY, Frequency.DAILY)
		t = gm.find_by_id(1)
		h = gm.find_by_id(2)
		self.assertIsInstance(t.status_text(), str)
		self.assertIsInstance(h.status_text(), str)
		self.assertIn("Streak", h.status_text())


# Error Handling Tests
class ErrorHandlingTests(BackendTestBase):
	def test_complete_invalid_id_raises(self):
		_, gm = self._new_profile()
		with self.assertRaises(ValueError):
			gm.complete_by_id(999, date.today())

	@unittest.expectedFailure
	def test_empty_task_title_should_be_rejected(self):
		_, gm = self._new_profile()
		gm.add_task("", "", Difficulty.EASY, None)
		self.assertEqual(len(gm.goals), 0)

	@unittest.expectedFailure
	def test_empty_habit_title_should_be_rejected(self):
		_, gm = self._new_profile()
		gm.add_habit("", "", Difficulty.EASY, Frequency.DAILY)
		self.assertEqual(len(gm.goals), 0)

	def test_parse_date_validation(self):
		self.assertEqual(parse_date("2026-02-10"), date(2026, 2, 10))
		self.assertIsNone(parse_date(""))
		self.assertIsNone(parse_date("bad"))

	def test_malformed_goal_line_is_rejected(self):
		storage = Storage("badgoal.txt")
		with open(storage.path, "w", encoding="utf-8") as f:
			f.write("PLAYER|Student|1|0|100\n")
			f.write("GOAL|TASK|not_an_id\n")
		with self.assertRaises(Exception):
			storage.load()


# Stability and Performance Tests
class StabilityPerformanceTests(BackendTestBase):
	def test_large_sets_save_load_and_repeat_cycles(self):
		player, gm = self._new_profile()
		for i in range(1500):
			gm.add_task(f"Task {i}", "", Difficulty.MEDIUM, None)
		for i in range(1500):
			gm.add_habit(f"Habit {i}", "", Difficulty.EASY, Frequency.DAILY)

		storage = Storage("studyquest_save.txt")
		start = time.perf_counter()
		for _ in range(3):
			storage.save(player, gm)
			player, gm = storage.load()
		elapsed = time.perf_counter() - start

		self.assertEqual(len(gm.goals), 3000)
		self.assertLess(elapsed, 20.0)


if __name__ == "__main__":
	suite = unittest.defaultTestLoader.loadTestsFromModule(sys.modules[__name__])
	runner = unittest.TextTestRunner(verbosity=2, resultclass=_GridTableTestResult)
	result = runner.run(suite)
	print("\n## Backend Test Results (Windows)\n")
	print(result.render_grid_table())
	raise SystemExit(0 if result.wasSuccessful() else 1)